name: ðŸš€ Deploy to EC2 (File Transfer)

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¦ Transfer files to EC2
        run: |
          # Create remote directory
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/fotomandalin"

          # Transfer all files
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.env*' \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fotomandalin/

      - name: ðŸš€ Deploy on EC2
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/fotomandalin
            
            echo "ðŸ”§ Creating environment file..."
            cat > .env.production << EOL
            # Database
            DATABASE_URL=postgresql://fotomandalin_user:${{ secrets.DB_PASSWORD }}@db:5432/fotomandalin
            DIRECT_URL=postgresql://fotomandalin_user:${{ secrets.DB_PASSWORD }}@db:5432/fotomandalin
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            # Application
            NODE_ENV=production
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            
            # Payment
            IYZICO_API_KEY=${{ secrets.IYZICO_API_KEY }}
            IYZICO_SECRET_KEY=${{ secrets.IYZICO_SECRET_KEY }}
            IYZICO_BASE_URL=${{ secrets.IYZICO_BASE_URL }}
            
            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
            
            # Email
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            EOL
            
            echo "ðŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.simple.yml --env-file .env.production down || true
            
            echo "ðŸ—ï¸ Building new images..."
            docker-compose -f docker-compose.simple.yml --env-file .env.production build --no-cache
            
            echo "ðŸš€ Starting services..."
            docker-compose -f docker-compose.simple.yml --env-file .env.production up -d
            
            echo "â³ Waiting for services..."
            sleep 30
            
            echo "ðŸ—„ï¸ Running database migrations..."
            docker-compose -f docker-compose.simple.yml --env-file .env.production exec -T app npx prisma migrate deploy || \
            docker-compose -f docker-compose.simple.yml --env-file .env.production exec -T app npx prisma db push
            
            echo "ðŸ§¹ Cleaning up..."
            docker image prune -f
            
            echo "âœ… Deployment completed!"
            docker-compose -f docker-compose.simple.yml --env-file .env.production ps
          EOF

      - name: ðŸ” Health Check
        run: |
          sleep 10
          if curl -f "http://${{ secrets.EC2_HOST }}/api/health"; then
            echo "âœ… Application is healthy!"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
